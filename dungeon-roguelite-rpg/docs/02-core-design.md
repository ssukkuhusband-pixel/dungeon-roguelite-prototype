# 코어 게임 디자인

## 코어 루프

### 한 판(런) 전체 플로우
```
[메인 화면: 모닥불 캠프]
    │
    ▼
[편성 화면] ← 보유 영웅 중 4명 선택
    │
    ▼
[던전 입장] ← 챕터 1 시작
    │
    ▼
┌─────────────────────────────────────────┐
│  스테이지 N (총 10스테이지)               │
│                                         │
│  ┌─ 일반/엘리트/보스 전투 ───────────┐    │
│  │  1. 적 등장 연출                   │    │
│  │  2. 턴 루프 (SPD 기반 행동순서)     │    │
│  │     - 가장 빠른 유닛부터 행동       │    │
│  │     - 자동 스킬 사용               │    │
│  │     - 타겟 자동 선택               │    │
│  │  3. 한쪽 전멸 시 전투 종료          │    │
│  └──────────────────────────────────┘    │
│         │                                │
│    승리? ──No──→ [패배 화면] → 메인 화면   │
│         │                                │
│        Yes                               │
│         │                                │
│  ┌─ 이벤트 스테이지인 경우 ──────────┐    │
│  │  (쉼터: HP 회복 선택)             │    │
│  └──────────────────────────────────┘    │
│         │                                │
│  ┌─ 스킬 선택 ──────────────────────┐    │
│  │  랜덤 3개 스킬 제시               │    │
│  │  플레이어가 1개 선택               │    │
│  │  선택 스킬 즉시 파티 전체에 적용    │    │
│  └──────────────────────────────────┘    │
│         │                                │
│    스테이지 10 클리어? ──No──→ 다음 스테이지│
│         │                                │
└─────────Yes──────────────────────────────┘
          │
          ▼
   [런 클리어 화면]
   - 획득 보상 표시 (골드, 소울스톤)
   - 메인 화면으로 복귀
```

### 한 턴의 플로우
```
1. 행동순서 결정: 생존 유닛 전체를 SPD 내림차순으로 정렬
2. 현재 유닛의 턴 시작
3. 스킬 자동 선택 (기본스킬 / 궁극기 조건 확인)
4. 타겟 자동 선택 (스킬 타입에 따라)
5. 스킬 실행 + 데미지/힐 계산
6. 피격 연출 + 수치 팝업
7. 사망 판정 (HP ≤ 0인 유닛 제거)
8. 전투 종료 판정 (한쪽 전멸 여부)
9. 종료 아니면 → 다음 유닛 턴으로
```

---

## 플레이어 액션

자동전투 기반이므로 플레이어의 직접 조작은 **전투 밖**에 집중된다.

| 액션 | 설명 | 입력 방식 | 발생 시점 |
|------|------|----------|----------|
| 영웅 편성 | 보유 영웅 중 4명을 선택하여 파티 구성 | 클릭/탭 (영웅 카드 선택) | 던전 입장 전 |
| 위치 배치 | 파티 내 영웅의 앞줄/뒷줄 위치 결정 | 드래그 또는 슬롯 클릭 | 편성 화면 |
| 던전 입장 | 챕터에 입장하여 런 시작 | 버튼 클릭 | 메인 화면 |
| 스킬 선택 | 전투 승리 후 3개 중 1개 스킬 선택 | 카드 클릭 | 전투 승리 후 |
| 이벤트 선택 | 이벤트 스테이지에서 선택지 고르기 | 버튼 클릭 | 이벤트 스테이지 |
| 전투 배속 | 자동전투 속도를 1x/2x로 변경 | 토글 버튼 | 전투 중 |
| 전투 관전 | 자동전투를 지켜본다 (개입 불가) | 없음 (자동) | 전투 중 |

---

## 전투 시스템 상세

### 전투 화면 레이아웃
```
┌─────────────────────────────────────────────────────────┐
│  [스테이지 N/10]              [배속 1x/2x]               │
│                                                         │
│   ┌─────┐ ┌─────┐    VS    ┌─────┐ ┌─────┐             │
│   │ 뒷줄 │ │ 앞줄 │          │ 앞줄 │ │ 뒷줄 │             │
│   │ 3번  │ │ 1번 │          │ 5번  │ │ 7번 │             │
│   │      │ │     │          │      │ │     │             │
│   └─────┘ └─────┘          └─────┘ └─────┘             │
│   ┌─────┐ ┌─────┐          ┌─────┐ ┌─────┐             │
│   │ 뒷줄 │ │ 앞줄 │          │ 앞줄 │ │ 뒷줄 │             │
│   │ 4번  │ │ 2번 │          │ 6번  │ │ 8번 │             │
│   │      │ │     │          │      │ │     │             │
│   └─────┘ └─────┘          └─────┘ └─────┘             │
│                                                         │
│  [HP바 표시] [턴 순서 표시 바]                              │
└─────────────────────────────────────────────────────────┘
```

**아군 배치 (왼쪽)**: 슬롯 1~2 = 앞줄 (전위), 슬롯 3~4 = 뒷줄 (후위)
**적 배치 (오른쪽)**: 슬롯 5~6 = 앞줄, 슬롯 7~8 = 뒷줄

### 턴 순서 결정 방식

**SPD(속도) 기반 턴 오더 시스템**

1. 라운드 시작 시 생존 유닛 전체의 SPD를 기준으로 내림차순 정렬
2. SPD가 동일하면: 아군 > 적 우선, 같은 진영 내에서는 슬롯 번호 오름차순
3. 모든 유닛이 1회씩 행동하면 1라운드 종료, 다음 라운드 시작
4. 버프/디버프에 의한 SPD 변동은 다음 라운드부터 적용

```typescript
// 턴 순서 계산 로직
function calculateTurnOrder(units: Unit[]): Unit[] {
  return units
    .filter(u => u.hp > 0)
    .sort((a, b) => {
      if (b.spd !== a.spd) return b.spd - a.spd;
      if (a.team !== b.team) return a.team === 'ally' ? -1 : 1;
      return a.slot - b.slot;
    });
}
```

### 스킬 자동 선택 로직

각 유닛은 **기본 스킬**과 **궁극기** 2개를 보유한다.

1. **궁극기 게이지 확인**: 게이지가 100 이상이면 궁극기 사용
2. **궁극기 게이지 미달**: 기본 스킬 사용
3. **궁극기 게이지 충전**: 기본 스킬 사용 시 +30, 피격 시 +20

```typescript
function selectSkill(unit: Unit): Skill {
  if (unit.ultimateGauge >= 100) {
    unit.ultimateGauge = 0;
    return unit.ultimateSkill;
  }
  unit.ultimateGauge += 30; // 기본 스킬 사용 시 충전
  return unit.basicSkill;
}
```

### 타겟 자동 선택 로직

| 스킬 타입 | 타겟 선택 규칙 |
|----------|---------------|
| 단일 공격 | 적 앞줄 우선 → 앞줄 중 HP 비율 가장 낮은 적 |
| 광역 공격 | 적 전체 |
| 앞줄 공격 | 적 앞줄만 (앞줄 전멸 시 뒷줄로 전환) |
| 단일 힐 | 아군 중 HP 비율 가장 낮은 아군 |
| 광역 힐 | 아군 전체 |
| 단일 버프 | 아군 중 ATK 가장 높은 아군 (버프 종류에 따라 다를 수 있음) |
| 광역 버프 | 아군 전체 |

```typescript
function selectTarget(unit: Unit, skill: Skill, allies: Unit[], enemies: Unit[]): Unit[] {
  const targets = skill.targetTeam === 'enemy' ? enemies : allies;
  const alive = targets.filter(t => t.hp > 0);

  switch (skill.targetType) {
    case 'single':
      if (skill.targetTeam === 'enemy') {
        // 앞줄 우선, HP 비율 가장 낮은 적
        const frontRow = alive.filter(t => t.position === 'front');
        const pool = frontRow.length > 0 ? frontRow : alive;
        return [pool.sort((a, b) => (a.hp / a.maxHp) - (b.hp / b.maxHp))[0]];
      } else {
        // 아군: HP 비율 가장 낮은 아군
        return [alive.sort((a, b) => (a.hp / a.maxHp) - (b.hp / b.maxHp))[0]];
      }
    case 'aoe':
      return alive;
    case 'front_row':
      const front = alive.filter(t => t.position === 'front');
      return front.length > 0 ? front : alive.filter(t => t.position === 'back');
    default:
      return [alive[0]];
  }
}
```

### 데미지 계산 공식

```
기본 데미지 = ATK * 스킬 배율
실제 데미지 = 기본 데미지 * (1 + 버프 합계) * (1 - 적 방어 보정)
방어 보정 = DEF / (DEF + 100)     // DEF 100일 때 50% 감소
```

예시:
- ATK 120, 스킬 배율 1.5x, 적 DEF 50 → 120 * 1.5 * (1 - 50/150) = 120
- ATK 120, 스킬 배율 1.5x, 적 DEF 100 → 120 * 1.5 * (1 - 100/200) = 90

```typescript
function calculateDamage(attacker: Unit, target: Unit, skill: Skill, buffs: Buff[]): number {
  const baseDamage = attacker.atk * skill.multiplier;
  const buffMultiplier = 1 + buffs
    .filter(b => b.type === 'atk_up' && b.target === attacker.id)
    .reduce((sum, b) => sum + b.value, 0);
  const defReduction = target.def / (target.def + 100);
  const finalDamage = Math.floor(baseDamage * buffMultiplier * (1 - defReduction));
  return Math.max(1, finalDamage); // 최소 데미지 1
}
```

### 힐 계산 공식

```
힐량 = 시전자 ATK * 스킬 힐 배율
```

### 위치(포지션)의 의미

| 위치 | 효과 | 적합 클래스 |
|------|------|-----------|
| 앞줄 (전위) | 적의 단일 공격 타겟이 될 확률 높음, 받는 데미지 -10% (방어 보정) | 탱커, 근접 딜러 |
| 뒷줄 (후위) | 앞줄 생존 시 단일 공격 대상에서 제외됨, 받는 데미지 +0% | 원거리 딜러, 힐러, 서포터 |

- 앞줄이 전멸하면 뒷줄이 단일 공격 대상이 됨
- 광역 공격은 위치 무관하게 전체 적중
- 앞줄 유닛은 `DEF +10%` 보너스를 받음 (위치 보정)

### 버프/디버프 시스템

| 상태 | 효과 | 지속 | 중첩 |
|------|------|------|------|
| ATK UP | 공격력 +30% | 2턴 | 불가 (갱신) |
| DEF UP | 방어력 +30% | 2턴 | 불가 (갱신) |
| SPD UP | 속도 +20% | 2턴 | 불가 (갱신) |
| ATK DOWN | 공격력 -25% | 2턴 | 불가 (갱신) |
| DEF DOWN | 방어력 -25% | 2턴 | 불가 (갱신) |
| 재생 (HOT) | 매 턴 시작 시 최대 HP의 8% 회복 | 3턴 | 불가 (갱신) |
| 출혈 (DOT) | 매 턴 시작 시 최대 HP의 6% 피해 | 3턴 | 최대 2중첩 |
| 기절 (STUN) | 행동 불가 | 1턴 | 불가 |

---

## 영웅 설계 (프로토타입용 6종)

### 클래스 역할 정의

| 클래스 | 역할 | 위치 권장 | 특징 |
|--------|------|----------|------|
| 탱커 (Tank) | 아군 보호, 적 견제 | 앞줄 | 높은 HP/DEF, 도발/보호 능력 |
| 전사 (Warrior) | 근접 물리 딜링 | 앞줄 | 높은 ATK, 중간 HP |
| 궁수 (Ranger) | 원거리 물리 딜링 | 뒷줄 | 높은 ATK/SPD, 낮은 HP |
| 마법사 (Mage) | 광역 마법 딜링 | 뒷줄 | 가장 높은 ATK, 가장 낮은 HP |
| 힐러 (Healer) | 회복, 버프 지원 | 뒷줄 | 낮은 ATK, 중간 HP, 힐 스킬 |
| 암살자 (Assassin) | 고폭 단일 딜링 | 앞줄 | 가장 높은 SPD, 크리티컬 특화 |

### 영웅 스탯 테이블

기준: 레벨 1 스탯. 모든 영웅의 궁극기 게이지는 0에서 시작, 100 필요.

| # | 이름 | 클래스 | HP | ATK | DEF | SPD | 기본스킬 | 궁극기 |
|---|------|--------|-----|-----|-----|-----|---------|--------|
| 1 | 아이언클래드 (Ironclad) | 탱커 | 600 | 45 | 80 | 35 | 방패 강타 | 철벽 수호 |
| 2 | 블레이드 (Blade) | 전사 | 420 | 95 | 50 | 50 | 베기 | 폭풍 참격 |
| 3 | 실바나 (Silvana) | 궁수 | 320 | 110 | 30 | 65 | 조준 사격 | 화살 비 |
| 4 | 이그니스 (Ignis) | 마법사 | 280 | 130 | 25 | 55 | 파이어볼트 | 메테오 스트라이크 |
| 5 | 루미나 (Lumina) | 힐러 | 380 | 70 | 40 | 45 | 빛의 치유 | 성스러운 축복 |
| 6 | 쉐도우 (Shadow) | 암살자 | 340 | 105 | 35 | 75 | 그림자 베기 | 암살 |

### 영웅별 스킬 상세

#### 1. 아이언클래드 (Ironclad) - 탱커
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 방패 강타 | 기본 | ATK * 0.8 + 도발 1턴 | 단일 적 | 적에게 데미지를 주고 1턴간 자신에게 어그로 집중 |
| 철벽 수호 | 궁극기 | 아군 전체 DEF UP 2턴 + 자신 HP 20% 회복 | 아군 전체 | 아군 전체의 방어력을 올리고 자신의 HP를 회복 |

**도발 효과**: 도발 대상이 있으면 적의 단일 공격이 도발 시전자에게 향함

#### 2. 블레이드 (Blade) - 전사
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 베기 | 기본 | ATK * 1.2 | 단일 적 | 적 하나에게 강력한 물리 공격 |
| 폭풍 참격 | 궁극기 | ATK * 0.8 + 출혈 (3턴) | 적 앞줄 | 적 앞줄에 광역 데미지 + 출혈 부여 |

#### 3. 실바나 (Silvana) - 궁수
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 조준 사격 | 기본 | ATK * 1.3 | 단일 적 (HP 가장 낮은) | 가장 약한 적을 노려 높은 배율로 공격 |
| 화살 비 | 궁극기 | ATK * 0.7 | 적 전체 | 적 전체에 화살을 퍼부음 |

**조준 사격 특수 타겟팅**: 앞줄 우선이 아닌 HP 비율이 가장 낮은 적을 타겟

#### 4. 이그니스 (Ignis) - 마법사
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 파이어볼트 | 기본 | ATK * 1.1 + 출혈 (3턴, 50% 확률) | 단일 적 | 불꽃 투사체로 적 1명 공격, 확률적 화상 |
| 메테오 스트라이크 | 궁극기 | ATK * 1.0 + DEF DOWN 2턴 | 적 전체 | 적 전체에 마법 데미지 + 방어력 감소 |

#### 5. 루미나 (Lumina) - 힐러
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 빛의 치유 | 기본 | ATK * 1.5 회복 | 아군 단일 (HP 가장 낮은) | HP가 가장 낮은 아군 1명을 회복 |
| 성스러운 축복 | 궁극기 | ATK * 1.0 회복 + 재생 3턴 | 아군 전체 | 아군 전체 HP 회복 + 재생 부여 |

#### 6. 쉐도우 (Shadow) - 암살자
| 스킬 | 타입 | 배율/효과 | 타겟 | 설명 |
|------|------|----------|------|------|
| 그림자 베기 | 기본 | ATK * 1.4 | 단일 적 (HP 가장 낮은) | 가장 약한 적을 노려 마무리 |
| 암살 | 궁극기 | ATK * 2.5 | 단일 적 (HP 비율 가장 낮은) | 가장 약한 적에게 초고배율 단일 데미지 |

**쉐도우 특수 타겟팅**: 기본 스킬/궁극기 모두 HP 비율이 가장 낮은 적을 타겟 (마무리 특화)

---

## 적 설계 (프로토타입용)

### 적 기본 타입

| 타입 | 역할 | 특징 |
|------|------|------|
| 졸개 (Minion) | 일반 적 | 낮은 스탯, 기본 공격만 |
| 정예 (Elite) | 강화 적 | 높은 스탯, 스킬 보유 |
| 보스 (Boss) | 보스 적 | 매우 높은 스탯, 강력한 궁극기 |

### 적 스탯 테이블 (기본 종류)

| 적 이름 | 타입 | HP | ATK | DEF | SPD | 기본스킬 | 특수능력 |
|---------|------|-----|-----|-----|-----|---------|---------|
| 고블린 병사 | 졸개 | 180 | 40 | 20 | 40 | 찌르기 (ATK*1.0) | 없음 |
| 고블린 궁수 | 졸개 | 140 | 55 | 15 | 50 | 독화살 (ATK*0.9 + 출혈 30%) | 없음 |
| 해골 전사 | 졸개 | 220 | 50 | 35 | 30 | 뼈도끼 (ATK*1.1) | 없음 |
| 다크 메이지 | 정예 | 300 | 80 | 25 | 55 | 암흑 화살 (ATK*1.2) | 궁극기: 저주 (아군 1명 ATK DOWN 2턴) |
| 오크 버서커 | 정예 | 500 | 70 | 40 | 35 | 돌진 (ATK*1.3) | 궁극기: 광폭화 (자신 ATK UP 2턴) |
| 뱀파이어 로드 | 정예 | 400 | 75 | 30 | 60 | 흡혈 (ATK*1.0, 데미지의 30% 회복) | 궁극기: 박쥐 떼 (전체 ATK*0.6 + 흡혈) |
| 던전 로드 | 보스 | 1200 | 90 | 60 | 45 | 대지 분쇄 (ATK*1.2, 앞줄 광역) | 궁극기: 종말의 일격 (전체 ATK*1.5 + DEF DOWN) |

### 스테이지별 적 구성

| 스테이지 | 타입 | 적 구성 (4체) | 전투력 기준 |
|---------|------|-------------|-----------|
| 1 | 일반 전투 | 고블린 병사 x3 + 고블린 궁수 x1 | 쉬움 |
| 2 | 일반 전투 | 고블린 병사 x2 + 고블린 궁수 x2 | 쉬움 |
| 3 | 일반 전투 | 해골 전사 x2 + 고블린 궁수 x2 | 보통 |
| 4 | 이벤트 (쉼터) | 전투 없음 - HP 회복 이벤트 | - |
| 5 | 엘리트 전투 | 다크 메이지 x1 + 해골 전사 x2 + 고블린 궁수 x1 | 어려움 |
| 6 | 일반 전투 | 해골 전사 x3 + 고블린 병사 x1 | 보통 |
| 7 | 일반 전투 | 고블린 궁수 x2 + 해골 전사 x2 | 보통 |
| 8 | 이벤트 (쉼터) | 전투 없음 - HP 회복 이벤트 | - |
| 9 | 엘리트 전투 | 오크 버서커 x1 + 뱀파이어 로드 x1 + 다크 메이지 x1 + 해골 전사 x1 | 매우 어려움 |
| 10 | 보스 전투 | 던전 로드 x1 + 오크 버서커 x1 + 다크 메이지 x1 + 해골 전사 x1 | 보스 |

### 적 배치 규칙
- 졸개/정예 근접형 (고블린 병사, 해골 전사, 오크 버서커): 앞줄
- 졸개/정예 원거리형 (고블린 궁수, 다크 메이지, 뱀파이어 로드): 뒷줄
- 보스: 항상 뒷줄 (부하가 앞줄 보호)
- 4체가 안 되는 경우: 앞줄 2 + 뒷줄 2로 배치, 남는 자리는 비움

### 이벤트 스테이지: 쉼터

쉼터 이벤트에서 플레이어에게 제시되는 선택지:

| 선택지 | 효과 | 설명 |
|--------|------|------|
| 모닥불에서 쉬기 | 아군 전체 HP 30% 회복 | 안전한 선택 |
| 비밀 상자 열기 | 스킬 1개 추가 획득 (랜덤) | 스킬 풀에서 랜덤 1개, HP 회복 없음 |

---

## 로그라이트 스킬 풀

전투 승리 후 랜덤 3개가 제시되며, 플레이어가 1개를 선택한다.
스킬은 파티 전체 또는 특정 조건에 적용된다.
**같은 스킬을 중복 획득할 수 없다** (이미 보유한 스킬은 풀에서 제외).

### 등급 체계
| 등급 | 출현 확률 | 색상 | 효과 강도 |
|------|----------|------|----------|
| 일반 (Common) | 60% | 회색 | 약 |
| 희귀 (Rare) | 30% | 파랑 | 중 |
| 전설 (Legendary) | 10% | 금색 | 강 |

### 스킬 목록 (18개)

#### 일반 등급 (Common) - 8개

| # | 스킬명 | 효과 | 적용 대상 | 설명 |
|---|--------|------|----------|------|
| 1 | 체력 단련 | 아군 전체 최대 HP +10% | 파티 전체 | 기본적인 생존력 강화 |
| 2 | 공격 훈련 | 아군 전체 ATK +8% | 파티 전체 | 기본적인 화력 강화 |
| 3 | 민첩 훈련 | 아군 전체 SPD +10% | 파티 전체 | 먼저 행동할 수 있게 |
| 4 | 방어 훈련 | 아군 전체 DEF +10% | 파티 전체 | 받는 데미지 감소 |
| 5 | 응급 치료 | 전투 시작 시 아군 전체 HP 10% 회복 | 매 전투 시작 | 다음 전투를 약간 유리하게 |
| 6 | 전투 본능 | 궁극기 게이지 시작값 +20 | 파티 전체 | 궁극기를 더 빨리 사용 |
| 7 | 견고한 갑옷 | 앞줄 유닛 DEF +20% | 앞줄 유닛만 | 탱커 라인 강화 |
| 8 | 저격 훈련 | 뒷줄 유닛 ATK +12% | 뒷줄 유닛만 | 딜러 라인 강화 |

#### 희귀 등급 (Rare) - 6개

| # | 스킬명 | 효과 | 적용 대상 | 설명 |
|---|--------|------|----------|------|
| 9 | 흡혈의 문장 | 가하는 데미지의 12% 만큼 HP 회복 | 파티 전체 | 공격이 곧 회복 |
| 10 | 연쇄 반격 | 피격 시 20% 확률로 ATK*0.5 반격 | 파티 전체 | 맞으면서 때리기 |
| 11 | 처형자의 본능 | 적 HP 25% 이하일 때 데미지 +50% | 파티 전체 | 마무리 특화 |
| 12 | 전쟁의 함성 | 전투 시작 시 아군 전체 ATK UP 2턴 | 매 전투 시작 | 초반 화력 폭발 |
| 13 | 마나 폭주 | 궁극기 데미지/힐 +30% | 파티 전체 | 궁극기 강화 |
| 14 | 가시 갑옷 | 피격 시 받은 데미지의 15% 를 공격자에게 반사 | 파티 전체 | 적이 아군을 때릴수록 손해 |

#### 전설 등급 (Legendary) - 4개

| # | 스킬명 | 효과 | 적용 대상 | 설명 |
|---|--------|------|----------|------|
| 15 | 불사의 의지 | 런 중 1회, 아군 1명 사망 시 HP 30%로 부활 | 파티 전체 (각 유닛 1회) | 사망 방지 보험 |
| 16 | 광전사의 혼 | 아군 HP 50% 이하일 때 ATK +40%, SPD +20% | 파티 전체 | 위기가 곧 기회 |
| 17 | 시간 가속 | 모든 아군 행동 후 15% 확률로 추가 턴 | 파티 전체 | 행동 횟수 증가 |
| 18 | 영혼 착취 | 적 처치 시 아군 전체 HP 15% 회복 + 궁극기 게이지 +15 | 파티 전체 | 킬 할 때마다 팀 전체 강화 |

### 스킬 제시 로직

```typescript
function presentSkillChoices(acquiredSkills: string[], stageNumber: number): Skill[] {
  const availableSkills = ALL_SKILLS.filter(s => !acquiredSkills.includes(s.id));
  const choices: Skill[] = [];

  for (let i = 0; i < 3; i++) {
    const roll = Math.random() * 100;
    let tier: SkillTier;
    if (roll < 10) tier = 'legendary';
    else if (roll < 40) tier = 'rare';
    else tier = 'common';

    const tierSkills = availableSkills.filter(s => s.tier === tier && !choices.includes(s));
    if (tierSkills.length > 0) {
      const selected = tierSkills[Math.floor(Math.random() * tierSkills.length)];
      choices.push(selected);
    } else {
      // 해당 등급에 남은 스킬이 없으면 아무 등급에서 선택
      const anySkills = availableSkills.filter(s => !choices.includes(s));
      if (anySkills.length > 0) {
        choices.push(anySkills[Math.floor(Math.random() * anySkills.length)]);
      }
    }
  }

  return choices;
}
```

---

## 스테이지 구성 (1챕터 = 10스테이지)

| 스테이지 | 타입 | 내용 | 클리어 보상 |
|---------|------|------|-----------|
| 1 | 일반 전투 | 고블린 병사 x3 + 고블린 궁수 x1 | 스킬 3택 |
| 2 | 일반 전투 | 고블린 병사 x2 + 고블린 궁수 x2 | 스킬 3택 |
| 3 | 일반 전투 | 해골 전사 x2 + 고블린 궁수 x2 | 스킬 3택 |
| 4 | 이벤트 (쉼터) | 모닥불 회복 or 비밀 상자 선택 | 선택에 따라 |
| 5 | 엘리트 전투 | 다크 메이지 x1 + 해골 전사 x2 + 고블린 궁수 x1 | 스킬 3택 (희귀↑ 확률 +10%) |
| 6 | 일반 전투 | 해골 전사 x3 + 고블린 병사 x1 | 스킬 3택 |
| 7 | 일반 전투 | 고블린 궁수 x2 + 해골 전사 x2 | 스킬 3택 |
| 8 | 이벤트 (쉼터) | 모닥불 회복 or 비밀 상자 선택 | 선택에 따라 |
| 9 | 엘리트 전투 | 오크 버서커 x1 + 뱀파이어 로드 x1 + 다크 메이지 x1 + 해골 전사 x1 | 스킬 3택 (희귀↑ 확률 +10%) |
| 10 | 보스 전투 | 던전 로드 x1 + 오크 버서커 x1 + 다크 메이지 x1 + 해골 전사 x1 | 런 클리어 보상 |

**엘리트/보스 전투 특수 규칙**:
- 엘리트 전투 (스테이지 5, 9): 스킬 3택에서 희귀 등급 이상 확률 +10% (희귀 40%, 전설 10%, 일반 50%)
- 보스 전투 (스테이지 10): 클리어 시 스킬 3택 없음, 대신 런 클리어 보상 (골드 + 소울스톤)

---

## 승리/패배 조건

### 전투 승리
- 적 4체가 모두 HP 0 이하가 되면 전투 승리

### 전투 패배
- 아군 4명이 모두 HP 0 이하가 되면 전투 패배

### 런 클리어 (대승리)
- 스테이지 10 보스를 격파하면 런 클리어
- 보상: 골드 100 + 소울스톤 10

### 런 실패
- 어떤 스테이지에서든 전투 패배 시 런 즉시 종료
- 보상: 진행한 스테이지에 비례한 골드만 지급 (스테이지 수 * 5 골드)
- 소울스톤은 미지급

### HP 유지 규칙
- **런 내 HP는 스테이지 간 유지된다** (로그라이트 핵심)
- 스테이지 1에서 다친 HP는 스테이지 2에서도 그대로
- 회복 수단: 쉼터 이벤트, 힐러 영웅, 로그라이트 스킬 (흡혈, 응급 치료 등)
- 사망한 유닛은 **해당 런에서 부활 불가** (전설 스킬 "불사의 의지" 제외)

---

## 핵심 수치 (밸런스 초안)

### 기본 전투 밸런스 지표

| 파라미터 | 값 | 비고 |
|---------|-----|------|
| 아군 평균 HP | 390 | 6영웅 평균 |
| 아군 평균 ATK | 92.5 | 6영웅 평균 |
| 아군 평균 DEF | 43.3 | 6영웅 평균 |
| 아군 평균 SPD | 54.2 | 6영웅 평균 |
| 졸개 평균 HP | 180 | 아군의 ~46% |
| 졸개 평균 ATK | 48.3 | 아군의 ~52% |
| 예상 일반전투 라운드 수 | 3~5 라운드 | 적 전멸까지 |
| 예상 보스전 라운드 수 | 6~10 라운드 | 보스 전멸까지 |
| 일반전투 예상 아군 피해율 | 15~25% | 총 HP 대비 |
| 엘리트전투 예상 아군 피해율 | 30~45% | 총 HP 대비 |
| 보스전 예상 아군 피해율 | 50~70% | 총 HP 대비 |

### 경제 수치

| 파라미터 | 값 | 비고 |
|---------|-----|------|
| 런 클리어 보상 (골드) | 100 | 스테이지 10 클리어 시 |
| 런 클리어 보상 (소울스톤) | 10 | 뽑기 재화 |
| 런 실패 보상 (골드) | 스테이지수 * 5 | 최대 45 (스테이지 9 패배) |
| 런 실패 보상 (소울스톤) | 0 | 미지급 |
| 가챠 1회 비용 (소울스톤) | 30 | 3런 클리어로 1회 뽑기 |

### 전투 속도 파라미터

| 파라미터 | 1x 속도 | 2x 속도 | 비고 |
|---------|---------|---------|------|
| 턴 행동 애니메이션 | 800ms | 400ms | 공격/스킬 연출 |
| 데미지 팝업 표시 | 600ms | 300ms | 숫자 표시 후 페이드 |
| 턴 전환 딜레이 | 400ms | 200ms | 다음 유닛으로 넘어가는 대기 |
| 라운드 전환 | 500ms | 250ms | 라운드 넘어갈 때 |
| 사망 연출 | 600ms | 300ms | 유닛 소멸 |
| 전투 승리 연출 | 1200ms | 600ms | 승리 텍스트 + 효과 |
| 예상 일반전투 총 시간 | ~25초 | ~12초 | 3~5라운드 기준 |

### 궁극기 게이지

| 파라미터 | 값 | 비고 |
|---------|-----|------|
| 궁극기 필요 게이지 | 100 | 100 도달 시 궁극기 발동 |
| 기본 스킬 사용 시 충전 | +30 | 4턴(기본스킬 4회) 만에 궁극기 가능 |
| 피격 시 충전 | +20 | 맞을수록 빨리 충전 |
| 전투 시작 초기값 | 0 | 로그라이트 스킬로 변동 가능 |
| 스테이지 간 게이지 유지 | Yes | 전투 종료 시 게이지 유지 |

---

## 난이도 설계

### 난이도 곡선 (1챕터 내)

```
난이도
  ▲
  │         ★ 보스
  │        ╱
  │     ◆╱   ← 엘리트
  │    ╱
  │ ◆╱       ← 엘리트
  │╱
  │─●─●─●─○─●─●─●─○─◆─★
  └──────────────────────→ 스테이지
    1  2  3  4  5  6  7  8  9  10

● = 일반 전투  ○ = 이벤트(쉼터)  ◆ = 엘리트  ★ = 보스
```

### 스테이지별 난이도 배율

적 스탯에 스테이지 보정을 적용한다:

| 스테이지 | HP 배율 | ATK 배율 | DEF 배율 | 적용 의미 |
|---------|---------|---------|---------|----------|
| 1 | 1.0x | 1.0x | 1.0x | 기본 |
| 2 | 1.05x | 1.05x | 1.0x | 약간 강화 |
| 3 | 1.1x | 1.1x | 1.05x | 보통 |
| 5 | 1.2x | 1.15x | 1.1x | 엘리트 보정 |
| 6 | 1.15x | 1.1x | 1.05x | 엘리트 이후 약간 쉬움 |
| 7 | 1.2x | 1.15x | 1.1x | 보통+ |
| 9 | 1.35x | 1.25x | 1.15x | 엘리트 보정 (강) |
| 10 | 1.5x | 1.3x | 1.2x | 보스 보정 |

### 밸런스 의도

- **스테이지 1~3**: 영웅 편성만 적절하면 무난히 클리어. 로그라이트 스킬 축적 구간.
- **스테이지 4 (쉼터)**: 누적 피해를 회복하거나 스킬을 추가 획득하는 전략적 선택.
- **스테이지 5 (엘리트)**: 첫 번째 벽. 스킬 빌드가 부실하면 여기서 큰 피해를 입음.
- **스테이지 6~7**: 회복기. 쉼터를 앞두고 적절한 난이도.
- **스테이지 8 (쉼터)**: 보스전을 앞둔 마지막 회복 기회.
- **스테이지 9 (엘리트)**: 두 번째 벽. 보스전 직전 가장 어려운 일반 전투.
- **스테이지 10 (보스)**: 최종 관문. 스킬 빌드 완성도와 잔여 HP가 핵심.

---

## 메타 시스템 접점

| 이벤트 | 메타로 전달하는 데이터 | 설명 |
|--------|---------------------|------|
| 런 클리어 (스테이지 10 클리어) | 골드 100, 소울스톤 10 | 메타 재화 획득 (뽑기/강화용) |
| 런 실패 (중도 패배) | 골드 (스테이지수 * 5) | 실패해도 최소 보상 |
| 영웅 편성 | 편성된 영웅 4명 ID | 메타에서 보유/강화한 영웅을 코어에서 사용 |
| 영웅 스탯 | HP, ATK, DEF, SPD | 메타에서 레벨업/강화로 올라간 스탯이 코어 전투에 반영 |
| 영웅 보유 여부 | 영웅 잠금/해금 상태 | 가챠로 획득한 영웅만 편성 가능 |

### 메타 → 코어 영향

| 메타 시스템 | 코어에 미치는 영향 | 구현 방식 |
|------------|------------------|----------|
| 영웅 레벨업 | 기본 스탯 증가 | 레벨당 HP+5%, ATK+3%, DEF+3%, SPD+1% |
| 새 영웅 획득 | 편성 선택지 확대 | 보유 영웅 목록에 추가, 편성 가능 |
| 초기 보유 영웅 | 런 시작 가능 | 게임 시작 시 기본 4영웅 제공 |

### 코어 → 메타 데이터 구조 (개발자 참고)

```typescript
interface RunResult {
  cleared: boolean;           // 런 클리어 여부
  stagesCleared: number;      // 클리어한 스테이지 수 (1~10)
  goldReward: number;         // 획득 골드
  soulStoneReward: number;    // 획득 소울스톤
  heroesUsed: string[];       // 사용한 영웅 ID 4개
  skillsAcquired: string[];   // 런에서 획득한 로그라이트 스킬 목록
  totalDamageDealt: number;   // 총 딜량 (통계용)
  totalDamageTaken: number;   // 총 피해량 (통계용)
  totalHealing: number;       // 총 힐량 (통계용)
}
```

---

## 개발자 전달 사항

### 구현 우선순위

| 순위 | 기능 | 설명 | 필수 여부 |
|------|------|------|----------|
| 1 | 전투 화면 레이아웃 | 4:4 횡스크롤 배치, HP 바, 턴 순서 UI | 필수 |
| 2 | 턴 기반 자동전투 엔진 | SPD 기반 턴 오더, 스킬 자동 선택, 타겟 자동 선택, 데미지 계산 | 필수 |
| 3 | 영웅 6종 데이터 | 스탯, 스킬, 궁극기 게이지 | 필수 |
| 4 | 적 데이터 + 스테이지 구성 | 적 7종 스탯, 10스테이지 웨이브 구성 | 필수 |
| 5 | 스킬 3택 시스템 | 전투 승리 후 스킬 선택 UI, 18개 스킬 풀 | 필수 |
| 6 | 스테이지 진행 | 10스테이지 순차 진행, HP 유지, 사망 유닛 유지 | 필수 |
| 7 | 이벤트 스테이지 (쉼터) | 스테이지 4, 8 쉼터 선택지 | 필수 |
| 8 | 전투 속도 조절 | 1x/2x 토글 | 권장 |
| 9 | 버프/디버프 시스템 | 상태 효과 적용/해제, 아이콘 표시 | 필수 |
| 10 | 런 결과 화면 | 클리어/패배 분기, 보상 표시 | 필수 |
| 11 | 편성 화면 | 보유 영웅 중 4명 선택, 위치(앞줄/뒷줄) 배치 | 필수 |

### 기술 구현 가이드

#### 게임 상태 관리
```typescript
interface GameState {
  // 런 상태
  currentStage: number;          // 현재 스테이지 (1~10)
  acquiredSkills: SkillId[];     // 획득한 로그라이트 스킬

  // 파티 상태 (런 내 유지)
  party: HeroState[];            // 4명의 현재 상태

  // 전투 상태
  battle: BattleState | null;    // 전투 진행 중 상태
}

interface HeroState {
  heroId: string;
  currentHp: number;
  maxHp: number;
  atk: number;
  def: number;
  spd: number;
  ultimateGauge: number;
  position: 'front' | 'back';
  isAlive: boolean;
  buffs: ActiveBuff[];
}

interface BattleState {
  allies: HeroState[];
  enemies: EnemyState[];
  turnOrder: string[];           // 유닛 ID 순서
  currentTurnIndex: number;
  round: number;
  battleLog: BattleLogEntry[];
  isFinished: boolean;
  result: 'victory' | 'defeat' | null;
}
```

#### 전투 엔진 핵심 루프
```typescript
// 전투 한 라운드 실행 (간략 의사코드)
function executeRound(state: BattleState): BattleState {
  const turnOrder = calculateTurnOrder([...state.allies, ...state.enemies]);

  for (const unit of turnOrder) {
    if (unit.hp <= 0) continue;

    // 턴 시작: DOT/HOT 처리
    applyTurnStartEffects(unit);
    if (unit.hp <= 0) { handleDeath(unit, state); continue; }

    // 기절 체크
    if (hasDebuff(unit, 'STUN')) { removeDebuff(unit, 'STUN'); continue; }

    // 스킬 선택
    const skill = selectSkill(unit);

    // 타겟 선택
    const targets = selectTarget(unit, skill, state.allies, state.enemies);

    // 스킬 실행
    executeSkill(unit, skill, targets, state);

    // 사망 판정
    checkDeaths(state);

    // 전투 종료 판정
    if (isTeamWiped(state.enemies)) { state.result = 'victory'; break; }
    if (isTeamWiped(state.allies)) { state.result = 'defeat'; break; }

    // 버프/디버프 턴 감소
    decreaseBuffDurations(unit);
  }

  state.round++;
  return state;
}
```

### 주의사항

1. **전투 연출과 로직 분리**: 전투 로직은 순수 함수로 구현하고, 연출(애니메이션)은 별도 레이어로 처리한다. 로직이 먼저 결과를 계산하고, UI가 결과를 순차 재생하는 구조.

2. **로그라이트 스킬 적용 시점**: 스킬은 획득 즉시 적용된다. 스탯 증가형은 즉시 반영, 조건형(흡혈, 반격 등)은 다음 전투부터 적용.

3. **HP 유지**: 스테이지 간 HP/궁극기 게이지/사망 상태가 유지되므로, 전투 종료 시 파티 상태를 반드시 런 상태로 저장해야 한다.

4. **애니메이션 큐**: 자동전투이므로 모든 행동이 큐에 쌓여 순차 재생되어야 한다. 빠른 전투(2x)는 큐의 재생 속도만 조절.

5. **스테이지 보정**: 적 스탯에 스테이지별 배율을 적용할 때, 기본 스탯 테이블과 배율 테이블을 분리하여 관리한다.

6. **사망 유닛 처리**: 사망한 유닛은 전투 화면에서 사라지되(혹은 쓰러진 연출), 다음 스테이지에도 편성에서 제외된다. UI에서 사망 상태를 시각적으로 보여준다.

7. **무한 루프 방지**: 전투가 50라운드를 초과하면 강제 패배 처리한다 (밸런스 안전장치).
